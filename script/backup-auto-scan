/* eslint-disable @typescript-eslint/no-require-imports */

const { chromium } = require('playwright'); 

// Função que irá rodar o script
(async () => {
    console.log("Iniciando o script...");

    const browser = await chromium.launch({ headless: false });
    const page = await browser.newPage();

    // Realizando o login
    await page.goto('https://minhaloja.plusdelivery.com.br/admin/login/');
    await page.fill('#login', 'elzalanches2019@gmail.com');
    await page.fill('#senha', 'Elza@270915');
    await page.click('.btn.btn-lg.btn-success.btn-block');

    // Esperar a página carregar completamente após o login
    await page.waitForSelector('.navbar-brand');  // Verifica se o login foi bem-sucedido com a presença do seletor
    const count = await page.locator('.navbar-brand').count();
    if (count > 0) {
        console.log('Login bem-sucedido!');
    } else {
        console.log('Falha no login ou o seletor não foi encontrado.');
        await browser.close();
        return;
    }

    // Esperar 15 segundos para garantir que a tabela seja carregada
    console.log('Aguardando 15 segundos para carregar a tabela...');
    await page.waitForTimeout(5000);  // 15 segundos

    // Coletar os pedidos da tabela
    const pedidos = await page.$$eval('#listaPedidos tr', async (rows) => {
        const pedidosArray = [];
        for (const row of rows) {
            const cols = row.querySelectorAll('td');
            if (cols.length > 0) {
                const pedido = {
                    id: cols[0]?.innerText.trim().replace('# ', ''),
                    cliente: cols[1]?.innerText.trim(),
                    dataHora: cols[2]?.innerText.trim(),
                    status: cols[3]?.innerText.trim() || null,
                };

                pedidosArray.push(pedido);
            }
        }
        return pedidosArray;
    });

    // Agora que temos o array de pedidos, vamos clicar nas linhas de cada pedido para coletar os detalhes
    for (const pedido of pedidos) {
        console.log(`Coletando detalhes para o pedido #${pedido.id}`);

        // Clicar na linha do pedido usando o identificador
        const linhaPedido = await page.locator(`#btnDetalhePedido[identificacao="${pedido.id}"]`);
        await linhaPedido.click(); // Clica na linha

        // Esperar a visualização detalhada carregar
        await page.waitForSelector('.ta_visualizar_pedido'); // Espera o painel de detalhes ser exibido

        // Coletar os dados do painel de detalhes
        const detalhes = await page.$eval('.ta_visualizar_pedido', (div) => {
            return div.innerHTML.trim(); // Pegando o HTML completo, mas você pode extrair as informações específicas se necessário
        });
        console.log(detalhes);

        // Adicionar os detalhes ao pedido
        pedido.detalhes = detalhes;

        // Aguarda o fechamento do painel, se necessário, ou a próxima interação
        await page.waitForTimeout(1000); 
    }

    // Exibir os pedidos com os dados detalhados
    console.log(pedidos);

    // Fechar o navegador após a execução
    await browser.close();
})();
